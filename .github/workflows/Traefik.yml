name: Deployment Workflow

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  Deploy-Docker-Infra:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy on remote server
        uses: appleboy/ssh-action@v1.2.0

        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

          # Traefik  test
          TRAEFIK_USER: ${{ secrets.TRAEFIK_USERS }}
          TRAEFIK_ID: ${{ secrets.TRAEFIK_PROVIDERS_GOOGLE_CLIENT_ID }}
          TRAEFIK_SECRET: ${{ secrets.TRAEFIK_PROVIDERS_GOOGLE_CLIENT_SECRET }}
          OAUTH_WHITELIST: ${{ secrets.TRAEFIK_OAUTH_WHITELIST }}
          APP_URL: ${{ secrets.TRAEFIK_APP_URL }}
          
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          envs: GH_TOKEN,FAIL2BAN_FAIL2BAN_UI_DOMAIN,FAIL2BAN_FAIL2BAN_UI_PORT,FAIL2BAN_TRAEFIK_MIDDLEWARE,FAIL2BAN_ENTRYPOINTS,FAIL2BAN_TLS,MONITORING_UPTIME_PUBLIC_HOST,MONITORING_UPTIME_PRIVATE_HOST,MONITORING_UPTIME_PORT,MONITORING_TRAEFIK_MIDDLEWARE,TASKLIST_TASKLIST_DOMAIN,TASKLIST_FRONTEND_PORT,TASKLIST_BACKEND_PORT,TASKLIST_TRAEFIK_MIDDLEWARE,TASKLIST_DB_HOST,TASKLIST_DB_PORT,TASKLIST_DB_USER,TASKLIST_DB_PASSWORD,TASKLIST_DB_NAME,TASKLIST_MARIADB_ROOT_PASSWORD,TRAEFIK_TRAEFIK_PORT_1,TRAEFIK_TRAEFIK_PORT_2,TRAEFIK_SERVER_PORT,TRAEFIK_TRAEFIK_DOMAIN,TRAEFIK_TRAEFIK_MIDDLEWARE,TRAEFIK_URL,TRAEFIK_USER,TRAEFIK_ID,TRAEFIK_SECRET,TRAEFIK_WHITELIST,TRAEFIK_TINYAUTH_URL,TRAEFIK_FORWARD_ADRESS,WIKI_URL_WIKI,WIKI_PORT

          script: |
            # clone le rep
            git clone https://$GH_TOKEN@github.com/DylanNovo/Serveur-Internet-Sample-Project.git
            
            # copie vers /root/srv
            rsync -av Serveur-Internet-Sample-Project/srv/tasklist/ /home/rocky/root/srv/


            # suppression du repo clon√©
            rm -rf Serveur-Internet-Sample-Project

            # Traefik
            cd /home/rocky/root/srv/traefik
            cat <<'EOF' > .env
            USERS=$TRAEFIK_USER
            PROVIDERS_GOOGLE_CLIENT_ID=$TRAEFIK_ID
            PROVIDERS_GOOGLE_CLIENT_SECRET=$TRAEFIK_SECRET
            OAUTH_WHITELIST=$OAUTH_WHITELIST
            APP_URL=$APP_URL
            EOF

            # lancement docker
            cd /home/rocky/root/srv/traefik
            docker compose up -d --force-recreate
