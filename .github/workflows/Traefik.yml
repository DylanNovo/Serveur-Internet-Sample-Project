name: Deployment Workflow

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  Deploy-Docker-Infra:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy on remote server
        uses: appleboy/ssh-action@v1.2.0

        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

          # Traefik  test
          TRAEFIK_USER: ${{ secrets.TRAEFIK_USERS }}
          TRAEFIK_PROVIDERS_GOOGLE_CLIENT_ID: ${{ secrets.TRAEFIK_PROVIDERS_GOOGLE_CLIENT_ID }}
          TRAEFIK_PROVIDERS_GOOGLE_CLIENT_SECRET: ${{ secrets.TRAEFIK_PROVIDERS_GOOGLE_CLIENT_SECRET }}
          OAUTH_WHITELIST: ${{ secrets.TRAEFIK_OAUTH_WHITELIST }}
          APP_URL: ${{ secrets.TRAEFIK_APP_URL }}
          
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          envs: GH_TOKEN, USERS,TRAEFIK_PROVIDERS_GOOGLE_CLIENT_ID,TRAEFIK_PROVIDERS_GOOGLE_CLIENT_SECRET,OAUTH_WHITELIST,APP_URL

          script: |
            # clone le rep
            git clone https://$GH_TOKEN@github.com/DylanNovo/Serveur-Internet-Sample-Project.git
            
            # copie vers /root/srv
            rsync -av Serveur-Internet-Sample-Project/srv/traefik/ /home/rocky/root/srv/


            # suppression du repo clon√©
            rm -rf Serveur-Internet-Sample-Project

            # Traefik
            cd /home/rocky/root/srv/traefik
            cat <<'EOF' > .env
            USERS=$TRAEFIK_USER
            PROVIDERS_GOOGLE_CLIENT_ID=$TRAEFIK_ID
            PROVIDERS_GOOGLE_CLIENT_SECRET=$TRAEFIK_SECRET
            OAUTH_WHITELIST=$OAUTH_WHITELIST
            APP_URL=$APP_URL
            EOF

            # lancement docker
            cd /home/rocky/root/srv/traefik
            docker compose up -d --force-recreate
